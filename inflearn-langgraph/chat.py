import streamlit as st
from trading_graph import graph 

# Streamlit í˜ì´ì§€ ì„¤ì •
# í˜ì´ì§€ ì œëª©ê³¼ ì•„ì´ì½˜ì„ ì„¤ì •í•˜ì—¬ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
st.set_page_config(page_title="LangGraph + Streamlit", page_icon="ğŸ“ˆ")

# Streamlit UI êµ¬ì„±
# ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ì¸ ì œëª©ê³¼ ì„¤ëª…ì„ í‘œì‹œí•©ë‹ˆë‹¤.
st.title("ì£¼ì‹ ë¶„ì„ ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ")
st.markdown("""
ì´ ì•±ì€ ë©€í‹° ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì—¬ ì£¼ì‹ì„ ë¶„ì„í•©ë‹ˆë‹¤. 
ì£¼ì‹ í‹°ì»¤ì™€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹œë©´ ì¢…í•©ì ì¸ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.
""")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
# ì‚¬ìš©ìì™€ AI ê°„ì˜ ëŒ€í™” ë‚´ì—­ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ë¥¼ ì„¸ì…˜ ìƒíƒœì— ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
# Streamlitì˜ ì„¸ì…˜ ìƒíƒœëŠ” í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì–´ë„ ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤.
if 'message_list' not in st.session_state:
    st.session_state.message_list = []

# ì´ì „ ëŒ€í™” ë‚´ì—­ í‘œì‹œ
# ì €ì¥ëœ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ìˆœíšŒí•˜ë©° ì±„íŒ… í˜•ì‹ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
# ê° ë©”ì‹œì§€ëŠ” ë°œì‹ ì(ì‚¬ìš©ì/AI)ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
for message in st.session_state.message_list:
    with st.chat_message(message["role"]):
        st.write(message["content"])

# ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
# ì±„íŒ… ì…ë ¥ í•„ë“œë¥¼ í†µí•´ ì‚¬ìš©ìë¡œë¶€í„° ì£¼ì‹ í‹°ì»¤ì™€ ì§ˆë¬¸ì„ ë°›ìŠµë‹ˆë‹¤.
user_input = st.chat_input("ì£¼ì‹ í‹°ì»¤ì™€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 'AAPLì— íˆ¬ìí•´ì•¼ í• ê¹Œìš”?')")

# ê·¸ë˜í”„ ì‹¤í–‰ì„ ìœ„í•œ ê¸°ë³¸ ì„¤ì •
# ìŠ¤ë ˆë“œ IDë¥¼ í¬í•¨í•œ ì„¤ì • ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
# ì´ ì„¤ì •ì€ ê·¸ë˜í”„ ì‹¤í–‰ ì‹œ í•„ìš”í•œ ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
config = {
    'configurable': {
        'thread_id': '1234'
    }
}

# ì‚¬ìš©ì ì…ë ¥ì´ ìˆì„ ê²½ìš° ì²˜ë¦¬
if user_input:
    # ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ëŒ€í™” ë‚´ì—­ì— ì¶”ê°€
    # ì…ë ¥ëœ ë©”ì‹œì§€ë¥¼ ì„¸ì…˜ ìƒíƒœì˜ message_listì— ì¶”ê°€í•©ë‹ˆë‹¤.
    st.session_state.message_list.append({"role": "user", "content": user_input})
    
    # ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ UIì— í‘œì‹œ
    # ì±„íŒ… ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì…ë ¥ì„ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
    st.chat_message("user").write(user_input)
    
    # AI ì‘ë‹µ ìƒì„± ì¤‘ ë¡œë”© í‘œì‹œ
    # AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ë™ì•ˆ ì‚¬ìš©ìì—ê²Œ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
    with st.spinner("ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ì¤‘..."):
        # AI ì‘ë‹µì„ ì±„íŒ… ë©”ì‹œì§€ë¡œ í‘œì‹œ
        with st.chat_message("assistant"):
            try:
                # ê·¸ë˜í”„ ì‹¤í–‰ ë° AI ì‘ë‹µ ìƒì„±
                # ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ê·¸ë˜í”„ë¥¼ ì‹¤í–‰í•˜ì—¬ AI ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
                ai_message = graph.invoke(
                    {"messages": [("user", user_input)]}, config=config
                );
                
                # ìƒì„±ëœ AI ì‘ë‹µ ì¶”ì¶œ
                # ê·¸ë˜í”„ì˜ ìƒíƒœì—ì„œ ë§ˆì§€ë§‰ ë©”ì‹œì§€(AI ì‘ë‹µ)ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
                ai_message = graph.get_state(config).values['messages'][-1].content
                
                # AI ì‘ë‹µì„ UIì— í‘œì‹œ
                st.write(ai_message)
            
                # AI ì‘ë‹µì„ ëŒ€í™” ë‚´ì—­ì— ì¶”ê°€
                # ìƒì„±ëœ AI ì‘ë‹µì„ ì„¸ì…˜ ìƒíƒœì˜ message_listì— ì¶”ê°€í•©ë‹ˆë‹¤.
                st.session_state.message_list.append({"role": "assistant", "content": ai_message})
            
            except Exception as e:
                # ì—ëŸ¬ ì²˜ë¦¬
                # API í˜¸ì¶œ ì¤‘ ë°œìƒí•œ ì˜¤ë¥˜ë¥¼ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•©ë‹ˆë‹¤.
                st.error(f"Error during streaming: {str(e)}")
                # API ì†ë„ ì œí•œìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ì¼ ìˆ˜ ìˆìŒì„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦½ë‹ˆë‹¤.
                st.info("This may be due to API rate limits. Please wait a minute and try again with a simpler query.")


